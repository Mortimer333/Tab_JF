class TabJF{editor;lastX=0;isActive=!1;clipboard=[];stack={open:!0,building:[],trace:[]};pressed={shift:!1,ctrl:!1,alt:!1};pos={letter:null,line:null,el:null};selection={anchor:null,offset:-1,line:-1,reverse:!1,active:!1,expanded:!1};constructor(e,t={},s=!1){if(void 0===e?.nodeType)throw new Error("You can't create Editor JF without passing node to set as editor.");if(1!=e.nodeType)throw new Error("Editor node has to be of proper node type. (1)");this.editor=e,t.left=t.left||0,t.top=t.top||0,t.letter=t.letter||8.8,t.line=t.line||20,this.settings=t,this._save.debounce=this._hidden.debounce(this._save.publish,500);if([["remove","selected"],["remove","one"],["remove","word"],["action","paste"],["newLine"],["mergeLine"],["insert"]].forEach((e=>{this.set.preciseMethodsProxy(this,e)})),s){console.log("DebugMode");let e=Object.getOwnPropertyNames(TabJF.prototype),t=Object.getOwnPropertyNames(this),s=e.indexOf("constructor");s>-1&&e.splice(s,1);let i=e.concat(t);this.set.methodsProxy(this,i)}this.assignEvents(),this.caret.el=this.caret.create(this.editor),this.caret.hide()}_hidden={debounce:(e,t=300)=>{let s;return(...i)=>{clearTimeout(s),"clear"!==i[0]&&(s=setTimeout((()=>{e.apply(this,i)}),t))}}};_proxyHandle={main:this,get:function(e,t,s){},apply:function(e,t,s){const i=this.main.stack;let n,o=i.open;return i.open=!1,n=e.bind?e.bind(this.main)(...s):e(...s),i.building.push({name:e.name,args:s,res:n}),o&&(100==i.trace.length&&i.trace.shift(),i.trace.push(i.building),i.building=[],i.open=!0),n}};_proxySaveHandle={main:this,apply:function(e,t,s){const i=this.main._save;i.debounce();const n=i.inProgress;i.inProgress=!0;const o=i.tmp.length;i.methodsStack.push(e.name);const l=this.main.pos.line;i.set.add(e.name,s);const r=e.bind(this.main)(...s);return i.set.remove(e.name,s,o,l),n||(i.methodsStack=[],i.inProgress=!1,i.moveToPending()),r}};_save={_name:"save",debounce:void 0,version:0,tmpDefault:{fun_name:!1,remove:{sLine:-1,len:-1},after:{},add:{},focus:{letter:-1,line:-1,childIndex:-1},focusAfter:{letter:-1,line:-1,childIndex:-1}},tmp:[],pending:[],versions:[],methodsStack:[],inProgress:!1,moveToPending:()=>{this._save.pending=this._save.pending.concat(this._save.tmp),this._save.resetTmp()},set:{focus:()=>({letter:this.pos.letter,line:this.pos.line,childIndex:this.get.childIndex(this.pos.el)}),add:(e,t)=>{let s=0;"mergeLine"==e&&(s=t[0]);const i=JSON.parse(JSON.stringify(this._save.tmpDefault)),n=this.get.selection();if("range"==n.type.toLowerCase()){let e=n.anchorNode,t=this.selection.reverse?n.focusNode:this.pos.el;const s=this.get.linePos(this.get.line(e)),o=this.get.linePos(this.get.line(t));for(let e=s;e<=o;e++)i.add[e]=this.get.lineByPos(e).cloneNode(!0)}i.fun_name=e,i.focus=this._save.set.focus();const o=this.pos.line,l=this.get.lineByPos(o);if(i.add[o]||(i.add[o]=l.cloneNode(!0)),0!=s&&!i.add[o+s]){let e=this.get.lineInDirection(l,s);e&&(i.add[o+s]=e.cloneNode(!0))}this._save.tmp.push(i)},remove:(e,t,s,i)=>{const n=this._save,o=this.pos.line;if("one"==e&&"mergeLine"==n.methodsStack[n.methodsStack.length-1]||"mergeLine"==e&&"selected"==n.methodsStack[n.methodsStack.length-2])return void n.tmp.splice(s,1);if("paste"==e){let e=n.tmp[s];return e.remove={sLine:i,len:o-i+1},void(n.tmp=[e])}let l=n.tmp[s];l||(l=n.pending[s]),l.fun_name=e;const r=Object.keys(l.add);if(0==r.length)return;let h=o,c=Math.max(...r),d=Math.max(...r);h<d?(d=h,c=o):h>c?(c=h,d=o):(c=h,d=h),l.remove.sLine=d,l.remove.len=c-d+1,"newLine"==e&&(l.remove.sLine--,l.remove.len++);for(let e=l.remove.sLine;e<l.remove.sLine+l.remove.len;e++)l.after[e]=this.get.lineByPos(e).cloneNode(!0);l.focusAfter=n.set.focus()}},publish:()=>{const e=this._save;e.version>0&&(e.versions.splice(0,e.version),e.version=0),0!=e.pending.length&&(e.squash(),e.versions.unshift(e.pending.reverse()),e.pending=[])},squash:()=>{const e=this._save.pending;for(let t=1;t<e.length;t++){const s=e[t],i=e[t-1];this._save.checkStepsCompatibility(s,i)&&(i.after=s.after,i.focusAfter=s.focusAfter,e.splice(t,1),t--)}},checkStepsCompatibility:(e,t)=>e.fun_name==t.fun_name&&Object.values(e.remove).toString()==Object.values(t.remove).toString()&&Object.keys(e.add).toString()==Object.keys(t.add).toString(),resetTmp:()=>{this._save.tmp=[]},restore:()=>{const e=this._save;if(e.pending.length>0&&(e.publish(),e.debounce("clear")),e.versions.length==e.version)return;let t=e.versions[e.version];t.forEach((t=>{e.content.remove(t.remove),e.content.add(t.add)})),e.refocus(t[0].focus),e.version++},refocus:e=>{let t=this.get.lineByPos(e?.line);t?this.set.pos(t.childNodes[e.childIndex],e.letter,e.line):console.error("Line not found! Please refocus caret.")},recall:()=>{const e=this._save;if(e.version<=0)return;e.version--;const t=e.versions[e.version];t.forEach((t=>{const s={},i=Object.keys(t.add);s.sLine=Math.min(...i);const n=Math.max(...i);s.len=n-s.sLine+1,e.content.remove(s),e.content.add(t.after)})),e.refocus(t[0].focusAfter)},content:{remove:e=>{for(let t=e.sLine;t<e.len+e.sLine;t++){let t=this.get.lineByPos(e.sLine);t&&t.remove()}},add:e=>{const t=Object.keys(e);let s=this.get.lineByPos(t[0]);s||(s=null),t.forEach((t=>{this.editor.insertBefore(e[t].cloneNode(!0),s)}))}}};start={_name:"start",select:()=>{this.selection.anchor=this.pos.el,this.selection.offset=this.pos.letter,this.selection.line=this.pos.line,this.selection.active=!0}};expand={_name:"expand",select:(e=!1)=>{this.selection.expanded=!0;const t=new Range;this.selection.reverse?(t.setStart(this.pos.el.childNodes[0],this.pos.letter),t.setEnd(this.selection.anchor.childNodes[0],this.selection.offset)):(t.setStart(this.selection.anchor.childNodes[0],this.selection.offset),t.setEnd(this.pos.el.childNodes[0],this.pos.letter)),this.get.selection().removeAllRanges(),this.get.selection().addRange(t),e||(this.get.selection().isCollapsed&&!this.selection.reverse?(this.selection.reverse=!0,this.expand.select(!0)):this.get.selection().isCollapsed&&this.selection.reverse&&(this.selection.reverse=!1,this.expand.select(!0)))}};end={_name:"end",select:()=>{this.get.selection().empty(),this.selection.anchor=null,this.selection.offset=-1,this.selection.line=-1,this.selection.reverse=!1,this.selection.active=!1,this.selection.expanded=!1,this.pressed.shift=!1}};remove={_name:"remove",selected:()=>{const e=this.selection.reverse;let t=e?this.pos.el:this.selection.anchor,s=e?this.pos.letter:this.selection.offset,i=e?this.pos.line:this.selection.line,n=e?this.selection.anchor:this.pos.el,o=e?this.selection.offset:this.pos.letter,l=e?this.selection.line:this.pos.line;if(null!=t&&null!=n){if(n==t){let e=n.childNodes[0];return e.nodeValue=e.nodeValue.slice(0,s)+e.nodeValue.slice(o),this.set.pos(n,s,l),void this.end.select()}n.childNodes[0].nodeValue=n.childNodes[0].nodeValue.slice(o),t.childNodes[0].nodeValue=t.childNodes[0].nodeValue.slice(0,s),this.remove.selectedRecursive(n,t),this.end.select(),this.set.pos(t,s,i),i!=l&&this.mergeLine(1)}},selectedRecursive:(e,t,s=!1,i=!1)=>{let n=e.previousSibling;if(i&&(n=e),n!=t){if(null==n){let i=this.get.line(e),n=this.get.lineInDirection(i,-1);return this.remove.selectedRecursive(n.children[n.children.length-1],t,!0,!0),void(s&&i.remove())}this.remove.selectedRecursive(n,t,s),n.remove()}},word:(e,t=this.pos.el,s=this.pos.letter)=>{if(0==t.innerText.length||e<0&&0==s||e>0&&s==t.innerText.length)return void this.mergeLine(e);let i,n,o,l=t.innerText;if(e<0?o=l.split("").reverse().indexOf(" ",l.length-s):e>0&&(o=l.indexOf(" ",s)),l.length-o===s&&e<0||o===s&&e>0)this.remove.one(e);else{if(-1===o){const s=t.previousSibling,i=t.nextSibling;e<0&&s?this.remove.word(e,s,s.innerText.length):e>0&&i&&this.remove.word(e,i,0),e<0&&(o=0),e>0&&(o=l.length)}else e<0&&(o=l.length-o);e<0?(i=l.substr(0,o),n=l.substr(s)):(i=l.substr(0,s),n=l.substr(o)),t.innerHTML=i+n,e<0&&this.set.pos(t,o,this.pos.line)}},one:e=>{const t=this.pos,s=t.el.nextSibling,i=t.el.previousSibling;let n,o,l=t.el.innerText;if(0!=l.length){if(1==l.length){if(this.remove.posElWithOnlyOneChar(e))return}if(e>0){if(t.letter>=l.length)return void this.remove.oneInSibling(s,e);n=l.substr(0,t.letter),o=l.substr(t.letter+1)}else{if(t.letter-1<0)return void this.remove.oneInSibling(i,e);n=l.substr(0,t.letter-1),o=l.substr(t.letter),this.caret.setByChar(t.letter-1,t.line)}t.el.innerHTML=n+o}else this.remove.oneInSibling(t.el,e)},oneInSibling:(e,t)=>{if(null!=e){if(1==e.innerText.length){if(this.remove.posElWithOnlyOneChar(t))return}if(1==e.nodeType&&0!=e.innerText.length)this.keys.move(t,0),this.remove.one(-1*t);else{let s=this.get.sibling(e,t);this.remove.oneInSibling(s,t)}}else this.mergeLine(t)},posElWithOnlyOneChar:e=>{if(0==this.pos.letter&&e>0||1==this.pos.letter&&e<0){const t=this.pos.el;let s=this.get.sibling(t,e);if(null===s&&(e*=-1,s=this.get.sibling(t,e),null===s)){const e=document.createElement("span"),i=document.createTextNode("");e.appendChild(i),this.pos.el.parentElement.insertBefore(e,t),s=e}return t.remove(),this.set.side(s,-1*e),!0}return!1}};set={_name:"set",preciseMethodsProxy:(e,t)=>{1==t.length?e[t[0]]=new Proxy(e[t[0]],this._proxySaveHandle):this.set.preciseMethodsProxy(e[t[0]],t.slice(1))},methodsProxy:(e,t)=>{for(var s=0;s<t.length;s++){let i=t[s];const n=typeof e[i];if("function"==n){if(e[i]==this.set.methodsProxy)continue;e[i]=new Proxy(e[i],this._proxyHandle)}else"object"==n&&null!==e[i]&&"_"!=i[0]&&this.set.methodsProxy(e[i],Object.keys(e[i]))}},side:(e,t,s=this.pos.line)=>{let i=this.pos.letter;this.pos.el=e,t>0?i=e.innerText.length:t<0&&(i=0),this.caret.setByChar(i,s)},pos:(e,t,s)=>{this.pos.el=e,this.pos.letter=t,this.pos.line=s,this.caret.setByChar(t,s)}};get={_name:"get",myself:()=>this,selectedLines:(e=null,t=null)=>{if(!e||!t){const s=this.get.selection(),i=this.selection.reverse&&!this.selection.expanded;e=this.get.line(i?s.focusNode:s.anchorNode),t=this.get.line(i?s.anchorNode:s.focusNode)}if(!e||!t)throw new Error("Couldn't find lines");return[e.cloneNode(!0),...this.get.selectedLinesRecursive(e.nextSibling,t)]},selectedLinesRecursive:(e,t)=>{if(null===e)throw new Error("The node doesn't exist in this parent");return e==t?[e.cloneNode(!0)]:"P"!==e.nodeName?this.get.selectedLinesRecursive(e.nextSibling,t):[e.cloneNode(!0),...this.get.selectedLinesRecursive(e.nextSibling,t)]},selectedNodes:()=>{const e=this.get.selection(),t=this.selection.reverse&&!this.selection.expanded;if("Caret"==e.type)return this.get.line(e.anchorNode);let s=t?e.focusNode:e.anchorNode,i=t?e.focusOffset:e.anchorOffset,n=t?e.anchorNode:e.focusNode,o=t?e.anchorOffset:e.focusOffset;if(s==n){let e=s.parentElement.cloneNode(!0);return e.innerHTML=e.innerHTML.substr(i,o-i),[e]}let l=this.get.selectedNodesRecursive(s.parentElement,n.parentElement,!s.parentElement.previousSibling),r=l.splice(0,1)[0].cloneNode(!0),h=l.splice(-1)[0].cloneNode(!0);r.innerHTML=r.innerText.substr(i),h.innerHTML=h.innerText.substr(0,o);let c=[r];return this.clipboard=[r],l.forEach((e=>{c.push(e.nodeName?e.cloneNode(!0):e)})),c.push(h),c},selectedNodesRecursive:(e,t,s=!1,i=[],n=[])=>{if(e==t)return i.push(e),n.concat(i);if(!e.nextSibling){let s=this.get.line(e);i=i.concat([e,"_jump"]),n=n.concat(i);let o=this.get.lineInDirection(s,1);return this.get.selectedNodesRecursive(o.children[0],t,!0,[],n)}return i.push(e),this.get.selectedNodesRecursive(e.nextSibling,t,s,i,n)},elPos:e=>{for(let t=0;t<e.parentElement.children.length;t++)if(e.parentElement.children[t]==e)return t;return!1},linePos:e=>{let t=0;for(let s=0;s<this.editor.children.length;s++){let i=this.editor.children[s];if(e==i)return t;i.nodeName&&"P"==i.nodeName&&t++}return!1},selection:()=>window.getSelection?window.getSelection():document.selection,realPos:()=>({x:Math.ceil((this.caret.getPos().left-this.settings.left)/this.settings.letter),y:this.pos.line}),line:e=>e.parentElement==this.editor?e:this.get.line(e.parentElement),lineByPos:e=>{let t=-1;for(var s=0;s<this.editor.children.length;s++){let i=this.editor.children[s];if("P"==i.nodeName&&t++,t==e)return i}return!1},lineInDirection:(e,t,s=!0)=>{if(s&&"P"!=e?.nodeName)throw new Error("Parent has wrong tag, can't find proper lines");if(!s&&"P"==e?.nodeName)return e;let i;if(null===e)return e;if(t<0?i=e.previousSibling:t>0&&(i=e.nextSibling),null===i)return i;if(1!=i.nodeType){let e;return t<0?e=i.previousSibling:t>0&&(e=i.nextSibling),i.remove(),this.get.lineInDirection(e,t,!1)}return"P"!=i.nodeName?this.get.lineInDirection(i,t,!1):-1==t||1==t?i:this.get.lineInDirection(i,t<0?t+1:t-1,!0)},sibling:(e,t)=>t>0?e.nextSibling:t<0?e.previousSibling:void 0,childIndex:e=>{for(var t=0;t<e.parentElement.childNodes.length;t++)if(e.parentElement.childNodes[t]==e)return t;return!1}};caret={_name:"caret",el:null,scrollTo:()=>{let e=this.get.realPos().x*this.settings.letter+this.settings.left,t=(this.pos.line+1)*this.settings.line,s=t-this.editor.offsetHeight>0?t-this.editor.offsetHeight:0;e>this.editor.offsetWidth-6*this.settings.letter?this.editor.scrollTo(e+6*this.settings.letter-this.editor.offsetWidth,s):this.editor.scrollTo(0,s)},set:(e,t)=>{this.caret.el.style.top=t+"px",this.caret.el.style.left=e+"px"},setByChar:(e,t)=>{let s=this.pos.el.offsetLeft+e*this.settings.letter;this.pos.letter=e,this.pos.line=t,this.caret.el.style.top=t*this.settings.line+this.settings.top+"px",this.caret.el.style.left=this.caret.pos.toX(s+this.settings.left)+"px",this.caret.scrollTo()},getPos:()=>({top:this.caret.el.style.top.replace("px",""),left:this.caret.el.style.left.replace("px","")}),move:(e,t)=>{let s=this.caret.getPos();this.caret.set(s.left+this.settings.letter*e,s.top+this.settings.line*t)},create:e=>{const t=document.createElement("div");return t.setAttribute("class","caret"),e.insertBefore(t,e.children[0]),t},pos:{_name:"pos",toX:e=>Math.round((e-this.settings.left)/this.settings.letter)*this.settings.letter+this.settings.left,toY:e=>Math.floor((e-this.settings.top)/this.settings.line)*this.settings.line+this.settings.top},hide:()=>{this.caret.el&&(this.caret.el.style.display="none"),this.isActive=!1},show:()=>{this.caret.el&&(this.caret.el.style.display="block"),this.isActive=!0}};action={_name:"action",copy:()=>{this.clipboard=this.get.selectedNodes(),document.execCommand("copy")},paste:()=>{let e=[];this.remove.selected();for(var t=0;t<this.clipboard.length;t++){let s=this.clipboard[t];if("_jump"==s){this.newLine();let t=document.createElement("span"),s=document.createTextNode("");t.appendChild(s),this.pos.el.parentElement.insertBefore(t,this.pos.el),this.set.side(t,1),e.push(t);continue}let i=s.cloneNode(!0);if("P"==s.nodeName){this.newLine();let e=this.get.line(this.pos.el);this.editor.insertBefore(i,e),this.set.side(e.children[0],1),this.pos.line++}else this.pos.el.parentElement.insertBefore(i,this.pos.el.nextSibling),this.set.side(i,1)}e.forEach((e=>{e.remove()}))},cut:()=>{this.clipboard=this.get.selectedNodes(),document.execCommand("copy"),this.remove.selected()},undo:()=>this._save.restore(),redo:()=>this._save.recall()};assignEvents(){document.addEventListener("keydown",this.key.bind?this.key.bind(this):this.key),this.editor.addEventListener("mousedown",this.active.bind?this.active.bind(this):this.active),this.editor.addEventListener("keyup",this.key.bind?this.key.bind(this):this.key),this.editor.addEventListener("mouseup",this.checkSelect.bind?this.checkSelect.bind(this):this.checkSelect)}checkSelect(e){let t=this.get.selection();if("Range"==t.type){this.selection.anchor=t.anchorNode.parentElement,this.selection.offset=t.anchorOffset,this.selection.active=!0;let e=this.get.linePos(this.get.line(t.anchorNode));this.selection.line=e;let s=this.get.linePos(this.get.line(t.focusNode));if(this.set.pos(t.focusNode.parentElement,t.focusOffset,s),e>s)return void(this.selection.reverse=!0);if(e==s){let e=this.get.elPos(t.anchorNode.parentElement),s=this.get.elPos(t.focusNode.parentElement);if(e>s)return void(this.selection.reverse=!0);if(e==s&&this.selection.offset>t.focusOffset)return void(this.selection.reverse=!0)}this.selection.reverse=!1}}active(e){if(e.target==this.editor||e.layerX<0||e.layerY<0)return;let t=e.target;"P"===t.nodeName&&(t=t.children[t.children.length-1]);let s=e.layerX;t.offsetWidth+t.offsetLeft<s&&(s=t.offsetWidth+t.offsetLeft);let i=this.caret.pos.toX(s+this.settings.left),n=this.caret.pos.toY(t.parentElement.offsetTop+this.settings.top);this.caret.set(i,n),this.pos.letter=Math.round((s-t.offsetLeft)/this.settings.letter),this.pos.line=Math.ceil((n-this.settings.top)/this.settings.line),this.pos.el=t,this.lastX=this.get.realPos().x,this.caret.show(),this.end.select()}updateSpecialKeys(e){!this.selection.anchor&&e.shiftKey&&this.start.select(e),this.pressed.shift=e.shiftKey,this.pressed.ctrl=e.ctrlKey,this.pressed.alt=e.altKey}key(e,t){if(this.updateSpecialKeys(e),"up"==t)return;if({112:!0,113:!0,114:!0,115:!0,116:!0,117:!0,118:!0,119:!0,120:!0,121:!0,122:!0,123:!0}[e.keyCode])return;({37:!0,38:!0,39:!0,40:!0,222:!0})[e.keyCode]&&e.preventDefault();const s={0:(e,t)=>{},8:(e,t)=>{this.keys.backspace(e)},9:(e,t)=>{this.keys.tab(e)},13:(e,t)=>{this.keys.enter(e)},16:(e,t)=>{},17:(e,t)=>{},18:(e,t)=>{},18:(e,t)=>{},20:(e,t)=>{},27:(e,t)=>{this.keys.escape(e)},32:(e,t)=>{this.keys.space(e)},33:(e,t)=>{this.toSide(0,1)},34:(e,t)=>{this.toSide(0,-1)},35:(e,t)=>{this.toSide(1,0)},36:(e,t)=>{this.toSide(-1,0)},46:(e,t)=>{this.keys.delete(e)},37:(e,t)=>{this.keys.move(-1,0)},38:(e,t)=>{this.keys.move(0,-1)},39:(e,t)=>{this.keys.move(1,0)},40:(e,t)=>{this.keys.move(0,1)},45:(e,t)=>{},67:(e,t)=>{this.pressed.ctrl?this.action.copy():this.insert(e.key)},86:(e,t)=>{this.pressed.ctrl?this.action.paste():this.insert(e.key)},88:(e,t)=>{this.pressed.ctrl?this.action.cut():this.insert(e.key)},89:(e,t)=>{this.pressed.ctrl?this.action.redo():this.insert(e.key)},90:(e,t)=>{this.pressed.ctrl?this.action.undo():this.insert(e.key)},91:(e,t)=>{},106:(e,t)=>{this.insert("*")},109:(e,t)=>{this.insert("-")},111:(e,t)=>{e.preventDefault()},144:(e,t)=>{},145:(e,t)=>{},182:(e,t)=>{},183:(e,t)=>{},default:(e,t)=>{}};const i=this.get.selection();!this.selection.active||{delete:!0,backspace:!0,escape:!0}[e.key.toLowerCase()]||this.pressed.ctrl||"Range"!=i.type||(this.keys[e.key.toLowerCase()]||1==e.key.length)&&this.remove.selected(),s[e.keyCode]||1!=e.key.length?(s[e.keyCode]||s.default)(e,t):this.insert(e.key)}toSide(e,t){if(0!=t)if(t<0){let e=this.editor.children.length-2;this.keys.move(0,e-this.pos.line)}else this.keys.move(0,-this.pos.line)}keys={_name:"keys",enter:e=>{this.newLine(e)},backspace:e=>{if(this.selection.active){"range"!=this.get.selection().type.toLowerCase()?this.remove.one(-1):this.remove.selected()}else this.pressed.ctrl?this.remove.word(-1):this.remove.one(-1)},tab:e=>{e.preventDefault();for(let e=0;e<2;e++)this.insert("&nbsp;")},escape:e=>{this.caret.hide(),this.end.selected()},space:e=>{this.insert("&nbsp;")},delete:e=>{this.selection.active?this.remove.selected():this.pressed.ctrl?this.remove.word(1):this.remove.one(1)},moveCtrl:(e,t=this.pos.el,s=this.pos.letter)=>{let i,n=t.innerText;if(e<0?i=n.split("").reverse().indexOf(" ",n.length-s):e>0&&(i=n.indexOf(" ",s)),n.length-i===s&&e<0)s--;else if(i===s&&e>0)s++;else{if(-1===i){const s=t.previousSibling,i=t.nextSibling;return e<0&&s?void this.keys.moveCtrl(e,s,s.innerText.length):e>0&&i?void this.keys.moveCtrl(e,i,0):void this.set.side(t,e)}e<0?s=n.length-i:e>0&&(s=i)}this.set.pos(t,s,this.pos.line),this.pressed.shift?this.expand.select():this.end.select()},move:(e,t,s=!1)=>{if(this.selection.active&&!this.pressed.shift&&(this.selection.reverse&&!this.selection.expanded&&e<0||e>0)&&(e=0),this.pressed.ctrl?this.keys.moveCtrl(e):0!=e&&this.keys.moveX(t,e),0!=t&&this.keys.moveY(t,e),0==this.pos.el.innerText.length&&!s){let t=this.pos.el;this.keys.move(e,0,!0),t.remove()}this.pressed.shift?this.expand.select():this.end.select()},moveX:(e,t)=>{const s=this.pos.el,i=s.previousSibling;if(this.pos.letter+t<=-1){if(!i||1!=i.nodeType){let e=this.get.lineInDirection(s.parentElement,-1);if(!e)return;return this.pos.el=e.children[e.children.length-1],this.caret.setByChar(s.innerText.length,this.pos.line-1),void(this.lastX=this.get.realPos().x)}this.pos.el=i,this.pos.letter=s.innerText.length}else if(this.pos.letter+t>s.innerText.length&&s.nextSibling&&1==s.nextSibling.nodeType)this.pos.el=s.nextSibling,this.pos.letter=0;else if(this.pos.letter+t>s.innerText.length){let e=this.get.lineInDirection(s.parentElement,1);if(!e)return;return this.pos.el=e.children[0],this.caret.setByChar(0,this.pos.line+1),void(this.lastX=this.get.realPos().x)}this.caret.setByChar(this.pos.letter+t,this.pos.line),this.lastX=this.get.realPos().x},moveY:(e,t)=>{const s=this.pos.line,i=this.pos.el.innerText.length;if(s+e<=-1)return;if(s+e>=this.editor.children.length-1)return;let n=this.get.realPos().x,o=this.get.lineInDirection(this.pos.el.parentElement,e);if(!o)return;if(o.innerText.length<n+t)return this.pos.el=o.children[o.children.length-1],void this.caret.setByChar(i,s+e);let l=0;for(let t=0;t<o.children.length;t++){let i=o.children[t];if(l+=i.innerText.length,l>=this.lastX)return this.pos.el=i,void this.caret.setByChar(this.lastX-(l-i.innerText.length),s+e)}this.pos.el=o.children[o.children.length-1],this.caret.setByChar(i,s+e)}};newLine(){let e=this.pos.el,t=this.getSplitRow();t.pre.innerText.length>0?(e.parentElement.insertBefore(t.pre,e),e.remove(),e=t.pre):(e.innerHTML="",e.appendChild(document.createTextNode("")));let s=document.createElement("p"),i=[];t.suf.forEach((e=>{e.innerText.length>0&&(s.appendChild(e),i.push(e))})),0==i.length&&(t.suf[0].appendChild(document.createTextNode("")),s.appendChild(t.suf[0]),i.push(t.suf[0]));let n=this.get.line(e);this.editor.insertBefore(s,n.nextSibling),this.pos.el=i[0],this.caret.setByChar(0,this.pos.line+1)}mergeLine(e){let t=this.get.line(this.pos.el);if("P"!=t.nodeName)throw new Error("Parent has wrong tag, can't merge lines");if(e<0){let s=this.get.lineInDirection(t,e);if(!s)return;let i=s.children[s.children.length-1];for(let e=t.children.length-1;e>=0;e--)t.children[0].innerText.length>0?s.appendChild(t.children[0]):t.children[0].remove();t.remove();let n=0;e>0&&(n=this.pos.el.innerText.length),this.set.side(i,1,this.pos.line-1)}else if(e>0){let s=this.get.lineInDirection(t,e);if(!s)return;for(let e=s.children.length-1;e>=0;e--)s.children[0].innerText.length>0?t.appendChild(s.children[0]):s.children[0].remove();s.remove()}}insert(e){let t=this.getSplitText();t.pre+=e,this.pos.el.innerHTML=t.pre+t.suf,this.caret.setByChar(this.pos.letter+1,this.pos.line)}getSplitText(){let e=this.pos.el.innerText;return{pre:e.substr(0,this.pos.letter),suf:e.substr(this.pos.letter)}}getSplitNode(){let e=this.pos.el.innerText;return{pre:this.setAttributes(this.pos.el,e.substr(0,this.pos.letter)),suf:this.setAttributes(this.pos.el,e.substr(this.pos.letter))}}setAttributes(e,t){let s=document.createElement("span");for(let t,i=0,n=e.attributes,o=n.length;i<o;i++)t=n[i],s.setAttribute(t.nodeName,t.nodeValue);return s.innerHTML=t,s}getSplitRow(){let e=this.getSplitNode(),t=this.getNextSiblignAndRemove(this.pos.el.nextSibling);return e.suf=[e.suf,...t],e}getNextSiblignAndRemove(e){if(null===e)return[];let t=[],s=this.setAttributes(e,e.innerText);if(t.push(s),e.nextSibling){let s=this.getNextSiblignAndRemove(e.nextSibling);t=t.concat(s)}return e.remove(),t}}
